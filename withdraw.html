<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Withdraw</title><link rel="stylesheet" href="css/style.css"></head>
<body>
  <div class="app">
    <div class="container">
      <div class="header"><div class="logo">Withdraw</div><div><a href="dashboard.html" class="button btn-ghost">Back</a></div></div>

      <div class="card">
        <p class="small">Minimum withdraw: <strong>$0.1</strong></p>
        <input id="w_amount" class="input" placeholder="Amount (e.g. 0.1)" />
        <input id="w_address" class="input" placeholder="TON Wallet Address" />
        <button id="doWithdraw" class="button btn-primary">Request Withdraw</button>
        <p id="w_status" class="small"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, addDoc, collection, getDoc, doc } from './js/firebase-init.js';
    import { getDoc as getDoc2 } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    document.getElementById('doWithdraw').addEventListener('click', async ()=>{
      const uid = localStorage.getItem('uid'); if(!uid){ alert('Login first'); location.href='login.html'; return; }
      const amount = Number(document.getElementById('w_amount').value || 0);
      const addr = document.getElementById('w_address').value.trim();
      if(amount < 0.1){ alert('Minimum is $0.1'); return; }
      if(!addr){ alert('Enter address'); return; }
      // deduct balance immediately
      const uRef = doc(db,'users',uid);
      const uSnap = await getDoc(uRef);
      if(!uSnap.exists()) return alert('User missing');
      const curBal = (uSnap.data().balance || 0);
      if(curBal < amount) return alert('Not enough balance');
      // create withdraw record and deduct
      await addDoc(collection(db,'withdraws'), { uid, email: uSnap.data().email, amount, address:addr, status:'pending', createdAt: serverTimestamp() });
      await updateDoc(uRef, { balance: curBal - amount });
      document.getElementById('w_status').innerText = 'âœ… Withdraw request sent (pending).';
      // notify admin via Telegram (client side) - use server for production
      try{
        const BOT_TOKEN = '7776385916:AAHNDwHIehk0FJ1zzdoNV8lNB5qE_6DbPks';
        const CHAT_ID = '5419054691';
        const text = `ðŸ“¥ Withdraw Request\nUser: ${uSnap.data().username || uSnap.data().email}\nAmount: $${amount}\nAddress: ${addr}\nStatus: pending`;
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: CHAT_ID, text }) });
      }catch(e){ console.warn('TG notify failed', e); }
    });
  </script>
</body>
</html>
