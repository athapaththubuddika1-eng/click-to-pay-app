<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Earn</title><link rel="stylesheet" href="css/style.css"></head>
<body>
  <div class="app">
    <div class="container">
      <div class="header"><div class="logo">Earn</div><div><a href="dashboard.html" class="button btn-ghost">Back</a></div></div>

      <div class="card center">
        <h3 class="huge">üéØ Watch Ads & Earn</h3>
        <p class="small">Captcha + watch ads ‚Üí rewards</p>

        <div style="margin:12px 0">
          <div style="display:flex;justify-content:center;align-items:center;gap:8px">
            <div id="captchaValue" class="small" style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;font-weight:800;letter-spacing:3px">ABCDE</div>
            <button id="reloadCaptcha" class="button btn-ghost">üîÑ</button>
          </div>
          <input id="captchaInput" class="input" placeholder="Type captcha here" />
          <button id="submitCaptcha" class="button btn-primary" style="width:100%;margin-top:8px">‚ñ∂ Submit & Open Ad</button>
          <button id="watchBtn" class="button btn-green" style="width:100%;margin-top:8px">‚ñ∂ Watch Ad (No Captcha)</button>
        </div>

        <p class="small">Captcha reward: <strong>$0.000200</strong> ¬∑ Ad reward: <strong>$0.000150</strong></p>
        <p id="status" class="small" style="margin-top:8px"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './js/firebase-init.js';
    import { doc, getDoc, updateDoc, serverTimestamp, addDoc, collection } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const ADS_LINK = 'https://www.effectivegatecpm.com/dnm2jrcaj?key=c73c264e4447410ce55eb32960238eaa';
    const CAPTCHA_USD = 0.0002;
    const AD_USD = 0.00015;

    function genCaptcha(){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let s=''; for(let i=0;i<5;i++) s+=chars.charAt(Math.floor(Math.random()*chars.length));
      document.getElementById('captchaValue').innerText = s;
    }
    genCaptcha(); document.getElementById('reloadCaptcha').onclick = genCaptcha;

    function openInTelegram(url){
      try{
        if(window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function'){
          window.Telegram.WebApp.openLink(url); return true;
        }
      }catch(e){}
      // fallback new tab
      const w = window.open(url,'_blank'); if(w) return true;
      window.location.href = url; return true;
    }

    async function addBalanceToUser(uid, amount){
      const uref = doc(db,'users',uid);
      await updateDoc(uref, { balance: ( (await getDoc(uref)).data().balance || 0) + amount });
    }

    function getUid(){ return localStorage.getItem('uid'); }

    // Captcha submit flow
    document.getElementById('submitCaptcha').addEventListener('click', async ()=>{
      const uid = getUid(); if(!uid){ alert('Login first'); location.href='login.html'; return; }
      const typed = (document.getElementById('captchaInput').value||'').trim().toUpperCase();
      const real = document.getElementById('captchaValue').innerText.trim().toUpperCase();
      if(!typed){ alert('Type captcha'); return; }
      if(typed !== real){ alert('Wrong captcha'); genCaptcha(); return; }

      // open ad in-app then start countdown on this page
      openInTelegram(ADS_LINK);
      document.getElementById('status').innerText = '‚è≥ Ad opened ‚Äî counting 5s...';
      document.getElementById('submitCaptcha').disabled = true;
      let t=5;
      const iv = setInterval(()=>{ t--; document.getElementById('status').innerText = `‚è≥ Counting ${t}s...`; if(t<0){ clearInterval(iv); (async ()=>{
        try{
          // award captcha + ad after watch
          await addBalanceToUser(uid, CAPTCHA_USD + AD_USD);
          // record withdrawal? no ‚Äî record activity
          await addDoc(collection(db,'activities'), { uid, type:'ad_watch', amount: CAPTCHA_USD + AD_USD, createdAt: serverTimestamp() });
          document.getElementById('status').innerText = `‚úÖ Earned $${(CAPTCHA_USD+AD_USD).toFixed(6)}!`;
          document.getElementById('submitCaptcha').disabled = false;
          document.getElementById('captchaInput').value='';
          genCaptcha();
        }catch(e){ console.error(e); alert('Error awarding'); document.getElementById('submitCaptcha').disabled = false; }
      })() } }, 1000);
    });

    // watch-only
    document.getElementById('watchBtn').addEventListener('click', ()=>{
      const uid = getUid(); if(!uid){ alert('Login first'); location.href='login.html'; return; }
      openInTelegram(ADS_LINK);
      document.getElementById('status').innerText = '‚è≥ Ad opened ‚Äî counting 5s...';
      document.getElementById('watchBtn').disabled = true;
      let t=5; const iv = setInterval(()=>{ t--; document.getElementById('status').innerText = `‚è≥ Counting ${t}s...`; if(t<0){ clearInterval(iv); (async ()=>{
        try{ await addBalanceToUser(uid, AD_USD); await addDoc(collection(db,'activities'), { uid, type:'ad_watch_only', amount: AD_USD, createdAt: serverTimestamp()}); document.getElementById('status').innerText = `‚úÖ Earned $${AD_USD.toFixed(6)}!`; document.getElementById('watchBtn').disabled = false; }catch(e){console.error(e)} })() } },1000);
    });
  </script>
</body>
</html>
