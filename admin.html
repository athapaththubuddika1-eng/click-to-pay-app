<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Panel ‚Äî Ads Click Pay</title>
<link rel="stylesheet" href="css/style.css"/>
</head>
<body>
<div class="app"><div class="container">
  <div class="header"><div class="logo">Admin Panel</div><div class="small muted">Only admins</div></div>

  <div id="loginCard" class="card">
    <p class="small">Admin sign in</p>
    <input id="admin_email" class="input" placeholder="Admin email" />
    <input id="admin_pass" class="input" placeholder="Admin password" type="password" />
    <div class="row" style="margin-top:8px">
      <button id="adminLogin" class="button btn-primary">üîê Login</button>
      <button id="showDemoCreds" class="button btn-ghost">‚ÑπÔ∏è Demo</button>
    </div>
  </div>

  <div id="adminArea" style="display:none">
    <div class="card">
      <h4 class="huge">Withdraw Requests</h4>
      <div id="withdrawsList" style="max-height:360px;overflow:auto"></div>
    </div>

    <div class="card">
      <h4 class="huge">Add Balance (by Email)</h4>
      <div class="row">
        <input id="addEmail" class="input" placeholder="User email" />
        <input id="addAmt" class="input" placeholder="Amount" />
      </div>
      <div style="margin-top:8px"><button id="doAdd" class="button btn-primary">‚ûï Add Balance</button></div>
    </div>

    <div class="card">
      <h4 class="huge">Tasks</h4>
      <div class="row">
        <input id="taskTitle" class="input" placeholder="Title" />
        <input id="taskUrl" class="input" placeholder="URL" />
        <input id="taskAmt" class="input" placeholder="Amount" />
      </div>
      <div style="margin-top:8px"><button id="addTask" class="button btn-primary">‚ûï Add Task</button></div>
      <ul id="taskList" style="margin-top:12px;padding-left:0"></ul>
    </div>
  </div>

</div></div>

<script type="module">
import { db, ref, get, push, update, set } from './js/firebase.js';

const ADMIN_EMAIL = 'hasanbuddika1@gmail.com';
const ADMIN_PASS = 'Aabbcc.123';
const BOT_ENDPOINT = '/api/sendTelegram';

document.getElementById('showDemoCreds').addEventListener('click', ()=>alert(`Admin: ${ADMIN_EMAIL}\nPass: ${ADMIN_PASS}`));
document.getElementById('adminLogin').addEventListener('click', async ()=>{
  const em = document.getElementById('admin_email').value.trim().toLowerCase();
  const pw = document.getElementById('admin_pass').value.trim();
  if(em===ADMIN_EMAIL && pw===ADMIN_PASS){ document.getElementById('loginCard').style.display='none'; document.getElementById('adminArea').style.display='block'; loadWithdraws(); loadTasks(); } else alert('Invalid admin credentials');
});

async function loadWithdraws(){
  const snap = await get(ref(db,'withdraws')); const list=document.getElementById('withdrawsList'); list.innerHTML='';
  if(!snap.exists()){ list.innerHTML='<div class="small-muted">No withdraws</div>'; return; }
  const ws = snap.val(); const keys = Object.keys(ws).reverse();
  for(const id of keys){
    const w = ws[id];
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${w.email||w.uid}</strong> ‚Ä¢ $${Number(w.amount).toFixed(4)}<div class="small-muted">${w.address||''} ‚Ä¢ ${w.status}</div></div><div style="display:flex;gap:8px"><button class="button btn-primary approve" data-id="${id}">‚úÖ Approve</button><button class="button btn-ghost reject" data-id="${id}">‚ùå Reject</button></div></div>`;
    list.appendChild(div);
  }
  list.querySelectorAll('.approve').forEach(b=>b.addEventListener('click', async e=>{ await approveWithdraw(e.target.dataset.id); await loadWithdraws(); }));
  list.querySelectorAll('.reject').forEach(b=>b.addEventListener('click', async e=>{ await rejectWithdraw(e.target.dataset.id); await loadWithdraws(); }));
}

async function approveWithdraw(id){
  await update(ref(db,`withdraws/${id}`), { status:'approved', processedAt:new Date().toISOString() });
  // notify via serverless
  const w = (await get(ref(db,`withdraws/${id}`))).val();
  try{ await fetch(BOT_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ text:`‚úÖ Withdraw Approved\nUser: ${w.email||w.uid}\nAmount: $${w.amount}\nAddress: ${w.address}` })}); }catch(e){ console.warn(e); }
  alert('Approved');
}

async function rejectWithdraw(id){
  const wSnap = (await get(ref(db,`withdraws/${id}`))).val();
  if(!wSnap) return alert('Not found');
  // refund
  const usersSnap = await get(ref(db,'users')); if(usersSnap.exists()){
    const users=usersSnap.val(); for(const k in users){ if(users[k].email===wSnap.email){ const cur=Number(users[k].balance||0); await update(ref(db,`users/${k}`), { balance: cur + Number(wSnap.amount) }); break; } }
  }
  await update(ref(db,`withdraws/${id}`), { status:'rejected', processedAt:new Date().toISOString() });
  alert('Rejected and refunded');
}

document.getElementById('doAdd').addEventListener('click', async ()=>{ const email=document.getElementById('addEmail').value.trim().toLowerCase(); const amt=Number(document.getElementById('addAmt').value||0); if(!email||!amt) return alert('Fill'); const usersSnap=await get(ref(db,'users')); if(!usersSnap.exists()) return alert('No users'); const users=usersSnap.val(); let found=null; for(const k in users){ if(users[k].email===email){ found={id:k,data:users[k]}; break; } } if(!found) return alert('User not found'); await update(ref(db,`users/${found.id}`), { balance: Number(found.data.balance||0) + amt }); alert('Balance added'); });

async function loadTasks(){ const tSnap=await get(ref(db,'tasks')); const tl=document.getElementById('taskList'); tl.innerHTML=''; if(!tSnap.exists()){ tl.innerHTML='<div class="small-muted">No tasks</div>'; return; } const ts=tSnap.val(); for(const k in ts){ const t=ts[k]; const li=document.createElement('li'); li.className='list-item'; li.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${t.title}</strong> ‚Ä¢ $${t.amount}</div><div><button class="button btn-ghost rm" data-id="${k}">üóë Remove</button></div></div>`; tl.appendChild(li); } tl.querySelectorAll('.rm').forEach(b=>b.addEventListener('click', async e=>{ await set(ref(db,`tasks/${e.target.dataset.id}`), null); loadTasks(); })); }

document.getElementById('addTask').addEventListener('click', async ()=>{ const title=document.getElementById('taskTitle').value.trim(); const url=document.getElementById('taskUrl').value.trim(); const amt=Number(document.getElementById('taskAmt').value||0); if(!title||!url||!amt) return alert('Fill'); await push(ref(db,'tasks'), { title, url, amount: amt, createdAt:new Date().toISOString() }); alert('Task added'); loadTasks(); });

</script>
</body>
</html>
