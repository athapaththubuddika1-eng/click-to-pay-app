<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Dashboard</title><link rel="stylesheet" href="css/style.css"></head>
<body>
  <div class="app">
    <div class="container">
      <div class="header">
        <div class="logo">Dashboard</div>
        <div><button id="logoutBtn" class="button btn-ghost">Logout</button></div>
      </div>

      <div class="card">
        <h3 class="huge">Welcome, <span id="username">â€”</span></h3>
        <p class="small">Balance: <strong id="userBalance">$0.000000</strong></p>
        <div style="margin-top:12px">
          <a href="earn.html" class="button btn-primary">Earn</a>
          <a href="withdraw.html" class="button btn-ghost">Withdraw</a>
          <a href="referral.html" class="button btn-green">Referral</a>
        </div>
      </div>

      <div class="card">
        <h4 class="huge">My Stats</h4>
        <p class="small">Referrals: <span id="myReferrals">0</span></p>
        <p class="small">Total Withdraws: <span id="myWithdraws">0</span></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, getDoc, doc, onAuthStateChanged } from './js/firebase-init.js';
    import { signOut } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import { getDoc as getDoc2 } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    async function loadProfile(){
      const uid = localStorage.getItem('uid');
      if(!uid){ location.href='login.html'; return; }
      const udoc = await getDoc(doc(db,'users',uid));
      if(!udoc.exists()) { alert('User not found'); return; }
      const data = udoc.data();
      document.getElementById('username').innerText = data.username || data.email;
      document.getElementById('userBalance').innerText = '$' + Number(data.balance || 0).toFixed(6);
      document.getElementById('myReferrals').innerText = data.referrals || 0;
      // count user's withdraws
      const wl = await (await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js')).getDocs((await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js')).collection(db,'withdraws'));
      const myW = wl.docs.filter(d=>d.data().uid === uid);
      document.getElementById('myWithdraws').innerText = myW.length;
    }
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{ localStorage.removeItem('uid'); await signOut(auth); location.href='index.html'; });
    loadProfile();
  </script>
</body>
</html>
